user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid       /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;

    client_max_body_size 20m;

    # -------------------------
    # SSL Hardening
    # -------------------------
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # -------------------------
    # Compression
    # -------------------------
    # Brotli (ONLY works if your image supports it)
    # You may comment these out if using plain nginx:alpine
    # brotli on;
    # brotli_comp_level 5;
    # brotli_types
    #     text/plain text/css text/xml
    #     application/json application/javascript application/xml
    #     application/rss+xml image/svg+xml;

    # Gzip fallback
    gzip on;
    gzip_comp_level 5;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain text/css text/xml
        application/json application/javascript application/xml
        application/rss+xml image/svg+xml;

    # -------------------------
    # Rate limiting (API)
    # -------------------------
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # -------------------------
    # Cache rules (mapping)
    # -------------------------
    map $request_uri $long_cache {
        default 0;
        ~*^/assets/ 1;
        ~*^/static/ 1;
        ~*^/fonts/ 1;
        ~*\.js$ 1;
        ~*\.css$ 1;
        ~*\.png$ 1;
        ~*\.jpg$ 1;
        ~*\.jpeg$ 1;
        ~*\.svg$ 1;
        ~*\.woff2$ 1;
    }

    # -------------------------
    # Security Headers
    # -------------------------
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=()" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Adjust CSP for your needs (Google auth included)
    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com;
        connect-src 'self' https://api.recallcode.test;
        img-src 'self' data:;
        style-src 'self' 'unsafe-inline';
        font-src 'self' data:;
    " always;

    # -------------------------
    # Common proxy headers
    # -------------------------
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 90;
    proxy_connect_timeout 10;
    proxy_send_timeout 30;

    include /etc/nginx/conf.d/*.conf;
}
